<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Snake</title>
    <style type="text/css">
        #canvasBox {
            background-color:white;
            border-radius:5px;
            border:1px solid #000;
        }
        #drawZoon {
            display: none;
        }
    </style>
    <script src="common.js"></script>
    <script type="application/javascript">
        let roomName = null;
        let roomId = null;
        let ticker = null;
        let direction = null;
        let ws = null;

        let c = null;
        let cc = null;
        let offsetLeft = 0;
        let offsetTop = 0;

        function showSnakeZoon() {
            document.getElementById('settingsZoon').style.display = 'none';
            document.getElementById('snakeZoon').style.display = 'block';
        }
        function initRoom() {
            roomId = getParam("roomId");
            console.log(roomId);
            roomName = getParam("roomName");
            if (roomName) {
                roomName = decodeURIComponent(roomName);
                document.getElementById('roomName').innerHTML = roomName;
            }
            if (roomId) {
                showSnakeZoon();
                initGame();
            }
        }
        function saveSettings() {
            showSnakeZoon();
            initGame();
        }
        function gameover() {
            alert('gameover');
            ws.close();
        }
        function initGame() {
            ws = new WebSocket('ws://localhost:3000/room/snake?roomName=' + encodeURIComponent(roomName) + '&roomId=' + roomId);

            ws.onopen = function () {
                console.log(`[CLIENT] open()`);
                if (!roomId) {
                    ws.send('N' + roomName);
                } else {
                    ws.send('J' + roomId);
                }
                initComponents();
            };

            ws.onclose = function() {
                console.log('Connection was closed');
            };

            ws.onmessage = function (event) {
                const m = event.data;
                console.log(m);
                if (m == null || m == null || m.length == 0)
                    return;
                const cmd = m.charAt(0);
                // N Inited room info
                // 2 画布信息
                // 3 画笔颜色
                // 4 画布粗细
                // 5 重置画布
                // 6 聊天信息
                // 7 结束
                if (cmd == 'N') {
                    console.log('房间创建成功');
                } else if (cmd == '2') {
                    const p = m.substring(1);
                    const xy = p.split(',');
                    drawPixel(xy[0], xy[1]);
                } else if (cmd == '3') {
                    cc.strokeStyle = m.substring(1);
                } else if (cmd == '4') {
                    cc.lineWidth = m.substring(1);
                } else if (cmd == '5') {
                    clearCanvas(false);
                } else if (cmd == '6') {
                    const s = m.substring(1);
                    const p = document.createElement('p');
                    p.innerHTML = s;
                    chatBox.appendChild(p);
                    if (correctAnswer && s == correctAnswer) {
                        ws.send('P7');
                        gameover();
                    }
                } else if (cmd == '7') {
                    gameover();
                }
            };
        }
        function initComponents() {
            c = document.getElementById('canvasBox');
            cc = c.getContext('2d');
            cc.lineWidth = 6;
            cc.strokeStyle = 'black';
            cc.lineJoin = 'round';
            cc.lineCap = "butt";
            offsetLeft = c.offsetLeft;
            offsetTop = c.offsetTop;
    
            c.onkeyup = function(event) {
                const k = event.keyCode;
                if (k == 38) {}
            };

            initRandomPlace();
        }
        function initRandomPlace() {
            const squareSize = 10;
            let _x = Math.floor(Math.random() * c.width);
            if (c.width - _x < 100)
                _x = c.width - 100;
                let _y = Math.floor(Math.random() * c.height);
            if (c.height - _y < 100)
                _y = c.height - 100;
            console.log("x="+_x+',y='+_y);
            const x = _x - offsetLeft;
            const y = _y - offsetTop;
            // cc.beginPath();
            cc.fillStyle = 'black';
            cc.fillRect(x, y, squareSize, squareSize);
            // cc.lineTo(x + 1, y + 1);
            // cc.closePath();
            // cc.stroke();
        }
    </script>
</head>
<body onload="initRoom();">
    <div class="roomName" id="roomName"></div>
    <div id="settingsZoon">
        <div>
            Difficulty:
            <select>
                <option value="2000">Easy</option>
                <option value="1000">Middle</option>
                <option value="500">Hard</option>
            </select>
        </div>
        <div>
            Mode:
            <select>
                <option value="amount">Amount</option>
                <option value="vs">Vs.</option>
            </select>
        </div>
        <div><button type="button" onclick="saveSettings();">Set</button></div>
    </div>
    <div id="snakeZoon">
        <div>
            <canvas id="canvasBox" width="1200" height="550"></canvas>
        </div>
    </div>
</body>
</html>
