<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Draw and guess</title>
    <style type="text/css">
        #canvasBox {
            background-color:white;
            border-radius:5px;
            border:1px solid #000;
        }
        #drawZoon {
            display: none;
        }
        #chatBox {
            background-color:white;
            border-radius:5px;
            border:1px solid #000;
            height: 450px;
            width: 300px;
            overflow: auto;
        }
    </style>
    <script src="common.js"></script>
    <script type="application/javascript">
        let roomName = null;
        let roomId = null;
        let correctAnswer = null;
        let drawer = false;
        let ws = null;
        let chatBox = null;
        let chatInput = null;

        let cc = null;
        let offsetLeft = 0;
        let offsetTop = 0;
        let selectedTd = null;
        let drawing = false;

        function showDrawZoon() {
            document.getElementById('settingsZoon').style.display = 'none';
            document.getElementById('drawZoon').style.display = 'block';
        }
        function initRoom() {
            roomId = getParam("roomId");
            console.log(roomId);
            roomName = getParam("roomName");
            if (roomName) {
                document.getElementById('roomName').innerHTML = roomName;
            }
            if (roomId) {
                showDrawZoon();
                initGame();
            } else
                drawer = true;
        }
        function saveSettings() {
            correctAnswer = document.getElementById('correctAnswer').value;
            showDrawZoon();
            initGame();
        }
        function gameover() {
            alert('gameover');
            ws.close();
        }
        function initGame() {
            ws = new WebSocket('ws://localhost:3000/room/draw?roomName=' + encodeURIComponent(roomName) + '&roomId=' + roomId);

            ws.onopen = function () {
                console.log(`[CLIENT] open()`);
                if (drawer) {
                    ws.send('N' + roomName);
                } else {
                    ws.send('J' + roomId);
                }
                initComponents();
            };

            ws.onclose = function() {
                console.log('Connection was closed');
            };

            ws.onmessage = function (event) {
                const m = event.data;
                console.log(m);
                if (m == null || m == null || m.length == 0)
                    return;
                const cmd = m.charAt(0);
                // N Inited room info
                // 2 画布信息
                // 3 画笔颜色
                // 4 画布粗细
                // 5 重置画布
                // 6 聊天信息
                // 7 结束
                if (cmd == 'N') {
                    roomId = m.substring(1);
                    console.log('房间创建成功 id=' + roomId);
                } else if (cmd == '2') {
                    const p = m.substring(1);
                    const xy = p.split(',');
                    drawPixel(xy[0], xy[1]);
                } else if (cmd == '3') {
                    cc.strokeStyle = m.substring(1);
                } else if (cmd == '4') {
                    cc.lineWidth = m.substring(1);
                } else if (cmd == '5') {
                    clearCanvas(false);
                } else if (cmd == '6') {
                    const s = m.substring(1);
                    const p = document.createElement('p');
                    p.innerHTML = s;
                    chatBox.appendChild(p);
                    if (correctAnswer && s == correctAnswer) {
                        ws.send('P7');
                        gameover();
                    }
                } else if (cmd == '7') {
                    gameover();
                }
            };
        }
        function initComponents() {
            chatBox = document.getElementById('chatBox');
            chatInput = document.getElementById('chatInput');
            const c = document.getElementById('canvasBox');
            cc = c.getContext('2d');
            cc.lineWidth = 5;
            cc.strokeStyle = 'black';
            cc.lineJoin = 'round';
            cc.lineCap = "butt";
            offsetLeft = c.offsetLeft;
            offsetTop = c.offsetTop;
            if (!drawer) {
                document.getElementById('col2').style.visibility = 'hidden';
                return;
            }
    
            c.onmousedown = function(){drawing = true;};
            c.onmouseup = function(){drawing = false;};
            c.onmouseleave = function(){drawing = false;};
            c.onmousemove = function(event){draw(event);};

            const colorBoxDefaultStyle = '1px solid grey';
            // https://www.w3schools.com/colors/colors_names.asp
            const colors = [
                "AliceBlue","AntiqueWhite","Aqua","Aquamarine","Azure","Beige","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown",
                "BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","DarkBlue","DarkCyan",
                "DarkGoldenRod","DarkGray","DarkGrey","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","DarkOrange","DarkOrchid",
                "DarkRed","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkSlateGrey","DarkTurquoise","DarkViolet","DeepPink",
                "DeepSkyBlue","DimGray","DimGrey","DodgerBlue","FireBrick","FloralWhite","ForestGreen","Fuchsia","Gainsboro","GhostWhite",
                "Gold","GoldenRod","Gray","Grey","Green","GreenYellow","HoneyDew","HotPink","IndianRed","Indigo","Ivory","Khaki","Lavender",
                "LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenRodYellow","LightGray","LightGrey",
                "LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSlateGrey","LightSteelBlue",
                "LightYellow","Lime","LimeGreen","Linen","Magenta","Maroon","MediumAquaMarine","MediumBlue","MediumOrchid","MediumPurple",
                "MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream",
                "MistyRose","Moccasin","NavajoWhite","Navy","OldLace","Olive","OliveDrab","Orange","OrangeRed","Orchid","PaleGoldenRod",
                "PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Purple","RebeccaPurple",
                "Red","RosyBrown","RoyalBlue","SaddleBrown","Salmon","SandyBrown","SeaGreen","SeaShell","Sienna","Silver","SkyBlue","SlateBlue",
                "SlateGray","SlateGrey","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Tomato","Turquoise","Violet","Wheat","White",
                "WhiteSmoke","Yellow","YellowGreen"];
            const t = document.getElementById('colorsTable');
            let tr;
            for (let i = 0;i < colors.length;i++) {
                if (i % 10 == 0) {
                    tr = document.createElement('tr');
                    t.appendChild(tr);
                }
                const td = document.createElement('td');
                td.style.border = colorBoxDefaultStyle;
                td.style.cursor = 'pointer';
                td.style.backgroundColor = colors[i];
                td.style.width = '20px';
                td.style.height = '20px';
                td.onclick = function() {
                    if (selectedTd)
                        selectedTd.style.border = colorBoxDefaultStyle;
                    selectedTd = this;
                    cc.strokeStyle = this.style.backgroundColor;
                    this.style.border='1px solid black';
                    ws.send('P3'+this.style.backgroundColor);
                };
                tr.appendChild(td);
            }
        }
        function drawPixel(_x, _y) {
            const x = _x - offsetLeft;
            const y = _y - offsetTop;
            cc.beginPath();
            cc.moveTo(x, y);
            cc.lineTo(x + 1, y + 1);
            cc.closePath();
            cc.stroke();
        }
        function draw(e) {
            if (drawing) {
                drawPixel(e.pageX, e.pageY);
                ws.send('P2' + e.pageX + ',' + e.pageY);
            }
        }
        function clearCanvas(sync) {
            cc.fillStyle = 'white';
            cc.fillRect(0, 0, 600, 500);
            if (sync)
                ws.send('P5');
        }
        function chat() {
            ws.send('B6' + chatInput.value);
            chatInput.value = '';
        }
    </script>
</head>
<body onload="initRoom();">
    <div class="roomName" id="roomName"></div>
    <div id="settingsZoon">
        Enter the correct answer:
        <input type="text" id="correctAnswer" />
        <button type="button" onclick="saveSettings();">Set</button>
    </div>
    <div id="drawZoon">
        <div style="float:left">
            <canvas id="canvasBox" width='600' height='500'></canvas>
        </div>
        <div id="col2" style="float:left;width: 270px;">
            笔的颜色:
            <table id="colorsTable">
            </table>
            笔的粗细:
            <select onchange="cc.lineWidth = this.value;ws.send('P4'+this.value);">
                <option value="1">1</option>
                <option value="3">3</option>
                <option value="5" selected>5</option>
                <option value="7">7</option>
                <option value="9">9</option>
            </select>
            <br/>
            <button onclick='clearCanvas(true);'>清空画板</button>
        </div>
        <div style="float:left">
            <div id="chatBox"></div>
            <input id="chatInput" type="text"/> <button onclick='chat();'>发送</button>
        </div>
    </div>
</body>
</html>
